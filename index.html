<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti칩n de Turnos - UCE</title>
    
    <!-- Favicon de Redes (Globo terr치queo estilizado) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>游깷</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Estilos de la Tabla Calendario (Estilo Registro Civil) --- */
        .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .calendar-table th, .calendar-table td { border: 1px solid #d1d5db; padding: 0; text-align: center; vertical-align: top; height: 60px; }
        .calendar-table th { background-color: #f3f4f6; font-weight: 600; padding: 0.75rem 0.5rem; font-size: 0.875rem; }
        .calendar-table .time-label { background-color: #f3f4f6; font-weight: 500; padding: 0.5rem; font-size: 0.875rem; display: flex; align-items: center; justify-content: center; height: 100%; }
        
        .slot-container { width: 100%; height: 100%; padding: 4px; }
        .slot { width: 100%; height: 100%; border-radius: 0.375rem; border: 2px solid transparent; cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; font-size: 0.875rem; font-weight: 500; line-height: 1.2; overflow: hidden; }
        .slot .slot-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }

        /* --- Estilos de Slots (NUEVA L칍GICA CAPACIDAD) --- */
        .slot-free { background-color: #ffffff; border-color: #d1d5db; color: #374151; }
        .slot-free:hover { background-color: #eff6ff; border-color: #93c5fd; }
        .slot-selected { background-color: #3b82f6 !important; color: #ffffff !important; border-color: #2563eb !important; }
        
        .slot-partial { background-color: #e0f2fe; border-color: #7dd3fc; color: #0369a1; } /* 1/4 - 3/4 */
        .slot-full { background-color: #cbd5e1; border-color: #94a3b8; color: #475569; cursor: not-allowed; } /* 4/4 - Lleno */
        
        .slot-my-booking { background-color: #22c55e; border-color: #16a34a; color: white; font-weight: bold; } /* Verde */
        .slot-approved-other { background-color: #ef4444; border-color: #dc2626; color: white; } /* Rojo */
        
        .slot-past, .slot-blocked { background-color: #e5e7eb; color: #6b7280; cursor: not-allowed; border-color: #d1d5db; }
        .slot-blocked.admin-clickable { cursor: pointer; }
        .slot-blocked.admin-clickable:hover { background-color: #d1d5db; }

        /* --- Estilos del Sidebar (Modal) --- */
        #member-modal-wrapper { position: fixed; top: 0; right: 0; width: 450px; height: 100%; background-color: white; box-shadow: -4px 0 10px rgba(0, 0, 0, 0.2); transform: translateX(100%); transition: transform 0.3s ease-in-out; z-index: 50; }
        #member-modal-wrapper.open { transform: translateX(0); }
        .legend-slot { cursor: default !important; }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, updateDoc, arrayUnion, runTransaction, query, where, getDocs, deleteDoc, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURACI칍N ---
        const firebaseConfig = {
            apiKey: "AIzaSyCR4Kk7kIBpSW3cF02b8zUHegvV4WQNuyI", authDomain: "lab-redes-turnos.firebaseapp.com", projectId: "lab-redes-turnos", storageBucket: "lab-redes-turnos.firebasestorage.app", messagingSenderId: "592544790067", appId: "1:592544790067:web:00bde37b50d3edf9f59546"
        };
        
        const MAX_CAPACITY = 4;
        const COLLECTION = "slots_v6"; // NUEVA COLECCI칍N PARA SOPORTAR CAPACIDAD

        const ADMIN_CREDENTIALS = { "admin1@lab.edu": { name: "Admin General" }, "admin2@lab.edu": { name: "Admin Auxiliar" } };
        // Credenciales UCE (Solo @uce.edu.ec son l칤deres)
        const GRUPO_LIDERES = {
            "adromeroq@uce.edu.ec": { name: "Grupo 1", color: "red", email: "adromeroq@uce.edu.ec" }, "mpsafla@uce.edu.ec": { name: "Grupo 2", color: "yellow", email: "mpsafla@uce.edu.ec" },
            "matercero@uce.edu.ec": { name: "Grupo 3", color: "green", email: "matercero@uce.edu.ec" }, "admanangon@uce.edu.ec": { name: "Grupo 4", color: "blue", email: "admanangon@uce.edu.ec" },
            "lspulamarin@uce.edu.ec": { name: "Grupo 5", color: "indigo", email: "lspulamarin@uce.edu.ec" }, "eschaluisa@uce.edu.ec": { name: "Grupo 6", color: "purple", email: "eschaluisa@uce.edu.ec" },
            "batipanl@uce.edu.ec": { name: "Grupo 7", color: "orange", email: "batipanl@uce.edu.ec" }, "dmjimenezb@uce.edu.ec": { name: "Grupo 8", color: "pink", email: "dmjimenezb@uce.edu.ec" }
        };

        // DATOS REALES DE INTEGRANTES (Preservados)
        const GRUPOS_INTEGRANTES = {
            "Grupo 1": [ { nombre: "Alexis David Romero Quishpe", cedula: "1754302402" }, { nombre: "Evelyn Alejandra Salas Ibarra", cedula: "1724298854" }, { nombre: "Jessica Alicia Guaman Tigasi", cedula: "1753812666" }, { nombre: "Danny Acosta", cedula: "1724391543" }, { nombre: "Elian Steve Farinango Imbaquingo", cedula: "1755875877" } ],
            "Grupo 2": [ { nombre: "Safla Almeida Mateo Patricio ", cedula: "1728992031" }, { nombre: "Segovia D치valos Kevin Ariel ", cedula: "1729348415" }, { nombre: "Al-selwi Khulood ", cedula: "1760080331" }, { nombre: "Nasimba Collaguazo Israel Xavier ", cedula: "1755011747" }, { nombre: "Panchi Granda Wladimir Nikolai", cedula: "1724695315" } ],
            "Grupo 3": [ { nombre: "Mariuxi Anabel Tercero Ayo", cedula: "1751816982" }, { nombre: "Stalin Isaac Coral Valdiviezo", cedula: "000000000" }, { nombre: "Andres Gualberto Cuji Mu침oz", cedula: "1729276913" }, { nombre: "Angel Garcia", cedula: "000000000" }, { nombre: "Bryan Andrango", cedula: "1725855918" } ],
            "Grupo 4": [ { nombre: "Anthony Manangon", cedula: "1726339953" }, { nombre: "Marlon Argoti", cedula: "1726632720" }, { nombre: "Boris Carrera ", cedula: "1753716891" }, { nombre: "Noboa Condor Luisa Fernanda", cedula: "1728495407" }, { nombre: "Sasig Erik", cedula: "000000000" }, { nombre: "Estudiante 6", cedula: "0000000000" } ],
            "Grupo 5": [ { nombre: "Lenin Stalin Pulamarin Cumbal", cedula: "1050467479" }, { nombre: "Josue Viscaino", cedula: "1750238220" }, { nombre: "Danny Lopez", cedula: "1755864392" }, { nombre: "Dylan Sarmiento ", cedula: "1726392762" }, { nombre: "Jonathan Carvajal ", cedula: "1726421470" } ],
            "Grupo 6": [ { nombre: "Chaluisa Gaunotu침a Estiven Sebasti치n", cedula: "1726658808" }, { nombre: "Dom칤nguez Dom칤nguez Karla Sof칤a", cedula: "1753731643" }, { nombre: "Simba침a Muzo Erick Francisco", cedula: "1725195620" }, { nombre: "Silva Ruiz Stalin Jair", cedula: "1003595954" }, { nombre: "Sopa Tenorio Kerlly Johanna", cedula: "1727452839" }, { nombre: "Villalba Campa침a Zamir Andres", cedula: "1726564568" } ],
            "Grupo 7": [ { nombre: "Brandon Ariel Tipan Liquinchana", cedula: "1727431429" }, { nombre: "Bernardo Jhoel Loachamin Freire", cedula: "1727661249" }, { nombre: "Juan Esteban Chimarro Mejia", cedula: "1728082841" }, { nombre: "Bryan Daniel P칠rez Hoyos ", cedula: "1724742711" }, { nombre: "David Arturo Hurtado Recalde", cedula: "1754254701" } ],
            "Grupo 8": [ { nombre: "Danna Mikaela Jimenez Benitez", cedula: "2351060716" }, { nombre: "Carlos Patricio Chipantashi Pallo", cedula: "1755817184" }, { nombre: "Alexander Josu칠 Flores Villamar칤n", cedula: "1728128453" }, { nombre: "Darwin Stalin Quishpe Tupiza", cedula: "1750297143" }, { nombre: "Andrea Gisell Suntaxi Chalco ", cedula: "1753987187" } ]
        };
        
        // --- VARIABLES GLOBALES Y CONEXI칍N ---
        let userId, userRole, currentGroupInfo, currentWeekOffset = 0, selectedSlots = [];
        let reservationsListener = null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const views = { login: document.getElementById('login-view'), student: document.getElementById('student-dashboard'), admin: document.getElementById('admin-dashboard'), loading: document.getElementById('loading-view') };
        const messageBox = document.getElementById('message-box');
        const memberModal = document.getElementById('member-modal-wrapper');

        // --- UTILIDADES ---

        function showView(name) { Object.values(views).forEach(v => v?.classList.add('hidden')); views[name]?.classList.remove('hidden'); }
        function showMessage(type, text) { 
            if(!messageBox) return; messageBox.innerText = text; messageBox.className = `mb-4 p-3 rounded text-sm ${type==='error'?'bg-red-100 text-red-700':'bg-green-100 text-green-700'}`; messageBox.classList.remove('hidden'); 
        }
        function hideMessage() { if (messageBox) messageBox.classList.add('hidden'); }

        function getWeekDays(offset = 0) {
            const now = new Date(); now.setDate(now.getDate() + (offset * 7));
            const today = now.getDay(), diff = (today == 0 ? -6 : 1) - today;
            const monday = new Date(now.setDate(now.getDate() + diff));
            return Array.from({length: 5}, (_, i) => { const t = new Date(monday); t.setDate(monday.getDate()+i); return t; });
        }
        function formatDateYYYYMMDD(date) { return date.toISOString().split('T')[0]; }
        const getSlotId = (d, h) => `${formatDateYYYYMMDD(d)}_${h}`;

        // --- AUTH ---

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                userRole = ADMIN_CREDENTIALS[user.email] ? 'admin' : 'student';
                if (userRole === 'student') {
                    currentGroupInfo = GRUPO_LIDERES[user.email] || { name: "Grupo Desconocido", color: "gray" };
                    currentGroupInfo.userId = userId;
                    currentGroupInfo.email = user.email;
                } else {
                    currentGroupInfo = { name: ADMIN_CREDENTIALS[user.email].name, userId: userId };
                }
                
                if(document.getElementById('student-header-name')) document.getElementById('student-header-name').innerText = currentGroupInfo.name;
                if(document.getElementById('admin-header-name')) document.getElementById('admin-header-name').innerText = currentGroupInfo.name;

                if (userRole === 'admin') { showView('admin'); setupAdminView(); }
                else { showView('student'); setupStudentView(); }
            } else {
                userId = null; userRole = null; currentGroupInfo = {}; selectedSlots = []; showView('login');
            }
        });

        window.handleLogin = async (e) => {
            e.preventDefault(); hideMessage();
            
            // --- FIX: Acceso Seguro al DOM ---
            const emailInput = document.getElementById('login-email');
            const passInput = document.getElementById('login-password');

            if (!emailInput || !passInput) {
                showMessage('error', 'Error interno: Formulario no cargado correctamente.');
                return;
            }

            const email = emailInput.value.trim().toLowerCase();
            const pass = passInput.value;

            if (!ADMIN_CREDENTIALS[email] && !GRUPO_LIDERES[email]) { showMessage('error', 'Credenciales no reconocidas.'); return; }

            try {
                if(auth.currentUser) await signOut(auth);
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) { showMessage('error', 'Error de credenciales.'); }
        };
        window.handleLogout = () => signOut(auth);


        // --- L칍GICA CORE V6.0 (CAPACIDAD Y ASISTENCIA) ---

        function updateSlotVisual(el, data, isStudent) {
            const groups = data.groups || [];
            const count = groups.length;
            const isBlocked = data.status === 'blocked';
            const myBooking = groups.find(g => g.email === currentGroupInfo.email);
            const isFull = count >= MAX_CAPACITY;
            
            el.dataset.groups = JSON.stringify(groups);
            el.dataset.status = isBlocked ? 'blocked' : (isFull ? 'full' : (count > 0 ? 'partial' : 'free'));
            el.dataset.isMine = !!myBooking;

            let content = '';
            
            if (isBlocked) {
                el.className = 'slot slot-blocked' + (userRole === 'admin' ? ' admin-clickable' : '');
                content = 'No Disponible';
                el.disabled = userRole !== 'admin';
            } else if (isFull) {
                el.className = 'slot slot-approved-other'; // Rojo (Lleno)
                content = `Lleno (4/4)`;
                el.disabled = true;
            } else if (myBooking) {
                el.className = 'slot slot-my-booking';
                content = 'Mi Turno';
                el.dataset.status = 'booked'; // Cambiar a 'booked' para diferenciar mi reserva
            } else if (count > 0) {
                el.className = 'slot slot-partial';
                content = `${count}/${MAX_CAPACITY} Cupos`;
            } else {
                el.className = 'slot slot-free';
                content = 'Disponible';
            }
            
            el.innerHTML = `<span class="slot-text font-bold">${content}</span>`;
        }

        // --- HANDLERS DE CLICK ---
        function handleSlotClick(el, id, isStudent) {
            const status = el.dataset.status;

            if (userRole === 'admin') {
                if (status === 'free' || status === 'blocked') {
                     // Selecci칩n para Bloqueo/Desbloqueo
                     toggleSelection(el, id);
                     document.getElementById('admin-action-box').classList.remove('hidden');
                } else if (status === 'booked' || status === 'partial' || status === 'full') {
                     // Ver detalles (Aprobado, Parcial, Lleno)
                     openDetailModal(id);
                }
            } else {
                // ESTUDIANTE
                if (status === 'free' || status === 'partial') {
                     toggleSelection(el, id);
                     updateStudentFab();
                } else if (status === 'booked') {
                     openDetailModal(id); // Ver mi reserva para cancelar
                }
            }
        }

        function toggleSelection(el, id) {
            const status = el.dataset.status;
            if(selectedSlots.includes(id)) {
                selectedSlots = selectedSlots.filter(s=>s!==id);
                el.classList.remove('slot-selected');
                
                // Restaurar texto y color (solo si es libre/bloqueado)
                if (status === 'free' || status === 'blocked') {
                    const content = status === 'free' ? 'Disponible' : 'Bloqueado';
                    el.innerHTML = `<span class="slot-text">${content}</span>`;
                }
            } else {
                selectedSlots.push(id);
                el.classList.add('slot-selected');
                el.querySelector('.slot-text').innerText = "Seleccionado";
            }
        }

        function updateStudentFab() {
             const fab = document.getElementById('student-fab');
             if(fab) {
                 if(selectedSlots.length) { fab.classList.remove('hidden'); fab.innerText = `Reservar (${selectedSlots.length})`; }
                 else fab.classList.add('hidden');
             }
        }


        // --- MODAL DE DETALLES Y ASISTENCIA ---
        function openDetailModal(slotId) {
            const el = document.getElementById(slotId);
            const allReservations = JSON.parse(el.dataset.groups || '[]');
            const isMyBooking = el.dataset.isMine === 'true';
            
            const modal = document.getElementById('member-modal-wrapper');
            const listContainer = document.getElementById('modal-list');
            const title = document.getElementById('modal-title');
            
            title.innerText = `Detalles: ${slotId} (${allReservations.length}/${MAX_CAPACITY} Grupos)`;
            listContainer.innerHTML = '';
            
            const displayReservations = (userRole === 'student' && !isMyBooking) 
                ? allReservations.filter(res => res.email === currentGroupInfo.email) // Estudiante solo ve su reserva (si la tiene)
                : allReservations;
            
            if (displayReservations.length === 0) {
                 listContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Informaci칩n de la reserva no disponible.</p>';
            }

            displayReservations.forEach(res => {
                const groupName = res.name;
                const members = GRUPOS_INTEGRANTES[groupName] || [];

                const groupDiv = document.createElement('div');
                groupDiv.className = "mb-6 p-4 border border-gray-200 rounded-lg shadow-sm";
                
                // Header y Botones
                let headerHtml = `<div class="flex justify-between items-start mb-3 border-b pb-2"><h4 class="font-bold text-base text-slate-800">${groupName}</h4>`;
                
                if (userRole === 'admin' || (userRole === 'student' && res.email === currentGroupInfo.email)) {
                    headerHtml += `<button onclick="window.removeGroup('${slotId}', '${res.email}')" class="text-xs bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"><i class="fas fa-trash"></i> Quitar Turno</button>`;
                }
                headerHtml += '</div>';
                groupDiv.innerHTML = headerHtml;

                // Lista de Integrantes y Asistencia
                const ul = document.createElement('ul');
                ul.className = "space-y-2 text-sm";
                
                members.forEach(m => {
                    const isChecked = res.attendance && res.attendance[m.cedula];
                    
                    let checkControl = '';
                    if (userRole === 'admin') {
                        checkControl = `<input type="checkbox" ${isChecked ? 'checked' : ''} onchange="window.toggleAtt('${slotId}', '${res.email}', '${m.cedula}', this.checked)" class="h-4 w-4 text-green-600 rounded">`;
                    } else if (res.email === currentGroupInfo.email) {
                        checkControl = `<span class="text-xs ${isChecked ? 'text-green-600' : 'text-gray-400'}">${isChecked ? 'ASISTI칍' : 'PENDIENTE'}</span>`;
                    }

                    ul.innerHTML += `<li class="flex justify-between"><span>${m.nombre}</span> <span>${checkControl}</span></li>`;
                });
                groupDiv.appendChild(ul);
                listContainer.appendChild(groupDiv);
            });
            
            memberModal.classList.add('open');
            document.getElementById('member-modal-overlay').classList.remove('hidden');
        }

        window.closeModal = () => {
            memberModal.classList.remove('open');
            document.getElementById('member-modal-overlay').classList.add('hidden');
        };

        // --- FUNCIONES DE TRANSACCI칍N ---
        window.confirmReservation = async () => { /* Implementar confirmaci칩n con runTransaction para slots seleccionados */ };
        window.handleAdminBlock = async (action) => { /* Implementar bloqueo/desbloqueo */ };

        window.removeGroup = async (slotId, email) => { /* Implementar eliminaci칩n de grupo del slot */ };
        window.toggleAtt = async (slotId, email, cedula, val) => { /* Implementar guardar asistencia */ };

        // --- HELPERS VIEW ---
        function setupStudentView() {
            setupWeekNavigation('student-prev-week', 'student-next-week', 'student-week-title', renderCalendar, true);
        }
        function setupAdminView() {
            setupWeekNavigation('admin-prev-week', 'admin-next-week', 'admin-week-title', renderCalendar, false);
        }

        function createHeaderCell(text) { const th = document.createElement('th'); th.innerText = text; return th; }
        function createTimeLabelCell(text) { const td = document.createElement('td'); td.className = 'time-label'; td.innerText = text; return td; }
        function createSlotContainer() { const div = document.createElement('div'); div.className = 'slot-container'; return div; }
        function createSlotElement(id, isStudent) { 
            const slot = document.createElement('button'); slot.id = id; slot.className = 'slot'; slot.type = 'button';
            slot.onclick = () => handleSlotClick(slot, id, isStudent);
            return slot;
        }

        // --- PUNTO DE ENTRADA ---
        function fillHeaders() {
            const template = document.getElementById('app-header-template'); if (!template) return;
            const studentPlaceholder = document.getElementById('student-header-placeholder');
            if (studentPlaceholder) { const h = template.content.cloneNode(true); h.getElementById('header-subtitle').innerText = 'Panel de Estudiante'; h.getElementById('header-name-display').id = 'student-header-name'; studentPlaceholder.appendChild(h); }
            const adminPlaceholder = document.getElementById('admin-header-placeholder');
            if (adminPlaceholder) { const h = template.content.cloneNode(true); h.getElementById('header-subtitle').innerText = 'Panel de Administraci칩n'; h.getElementById('header-name-display').id = 'admin-header-name'; adminPlaceholder.appendChild(h); }
        }
        fillHeaders(); showView('loading');
    </script>
</body>
</html>