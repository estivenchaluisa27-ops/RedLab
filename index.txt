<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti贸n de Turnos - UCE</title>
    
    <!-- Favicon de Redes (Globo terr谩queo estilizado) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22></text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- Estilos de la Tabla Calendario (Estilo Registro Civil) --- */
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Tablas no din谩micas */
        }
        .calendar-table th, .calendar-table td {
            border: 1px solid #d1d5db; /* border-gray-300 */
            padding: 0; /* Padding se maneja en el div interno */
            text-align: center;
            vertical-align: top;
            height: 60px; /* Altura de fila fija */
        }
        .calendar-table th {
            background-color: #f3f4f6; /* bg-gray-100 */
            font-weight: 600; /* font-semibold */
            padding: 0.75rem 0.5rem; /* p-3 px-2 */
            font-size: 0.875rem; /* text-sm */
        }
        .calendar-table .time-label {
            background-color: #f3f4f6;
            font-weight: 500;
            padding: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        /* Contenedor del Slot (dentro del <td>) */
        .slot-container {
            width: 100%;
            height: 100%;
            padding: 4px;
        }

        /* Slot (Bot贸n clickeable) */
        .slot {
            width: 100%;
            height: 100%;
            border-radius: 0.375rem; /* rounded-md */
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            line-height: 1.2;
            overflow: hidden; /* Para truncar texto */
        }
        .slot .slot-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* --- Estilos de Slots (Colores S贸lidos) --- */
        /* Blanco - Disponible */
        .slot-free {
            background-color: #ffffff; /* bg-white */
            border-color: #d1d5db; /* border-gray-300 */
            color: #374151; /* text-gray-700 */
        }
        .slot-free:hover {
            background-color: #eff6ff; /* hover:bg-blue-50 */
            border-color: #93c5fd; /* hover:border-blue-300 */
        }
        .slot-selected {
            background-color: #3b82f6 !important; /* bg-blue-500 */
            color: #ffffff !important; /* text-white */
            border-color: #2563eb !important; /* border-blue-600 */
        }
        
        /* Gris - No disponible (Pasado o Bloqueado) */
        .slot-past, .slot-blocked {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #6b7280; /* text-gray-500 */
            cursor: not-allowed;
            border-color: #d1d5db;
        }
        
        /* Amarillo - Pendiente */
        .slot-pending {
            background-color: #fef9c3; /* bg-yellow-100 */
            border-color: #facc15; /* border-yellow-400 */
            color: #713f12; /* text-yellow-900 */
        }
        
        /* Verde - Reservado - M铆o */
        .slot-approved-self {
            background-color: #22c55e; /* bg-green-500 */
            border-color: #16a34a; /* border-green-600 */
            color: white;
        }
        
        /* Rojo - Reservado - Ajeno */
        .slot-approved-other {
            background-color: #ef4444; /* bg-red-500 */
            border-color: #dc2626; /* border-red-600 */
            color: white;
        }
        
        /* Admin viendo colores de grupo */
        .slot-admin-view-pending { border-style: dashed; border-width: 2px; }
        .slot-admin-view-approved { font-weight: 600; } /* font-bold */
        
        /* CORRECCIN: Permitir click en slot bloqueado para admin */
        .slot-blocked.admin-clickable {
            cursor: pointer;
        }
        .slot-blocked.admin-clickable:hover {
            background-color: #d1d5db; /* hover:bg-gray-300 */
        }


        /* --- Estilo para la leyenda (est谩tica) --- */
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-slot {
            padding: 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            border: 2px solid;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            line-height: 1.2;
            width: 33.3333%; /* w-1/3 */
            margin-right: 0.75rem; /* mr-3 */
            cursor: default !important; /* No seleccionable */
        }
        /* Quitar hover del slot libre solo en la leyenda */
        .legend-item .slot-free:hover {
            background-color: #ffffff;
            border-color: #d1d5db;
        }

    </style>

  <script type="module">
    // --- IMPORTACIONES DE FIREBASE (CDN) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
      getAuth, 
      signInWithEmailAndPassword, 
      onAuthStateChanged, 
      signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
      getFirestore, 
      collection, 
      addDoc, 
      query, 
      where, 
      onSnapshot, 
      updateDoc, 
      doc, 
      deleteDoc,
      serverTimestamp,
      writeBatch,
      getDocs,
      getDoc,
      setDoc
      // 'orderBy' se quita intencionalmente para evitar error de 铆ndice
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- CONFIGURACIN DE FIREBASE (TUS DATOS REALES) ---
    const firebaseConfig = {
      apiKey: "AIzaSyCR4Kk7kIBpSW3cF02b8zUHegvV4WQNuyI",
      authDomain: "lab-redes-turnos.firebaseapp.com",
      projectId: "lab-redes-turnos",
      storageBucket: "lab-redes-turnos.firebasestorage.app",
      messagingSenderId: "592544790067",
      appId: "1:592544790067:web:00bde37b50d3edf9f59546"
    };
    
    // --- DATOS DE USUARIOS Y ESTTICA (Simulaci贸n de DB) ---
    
    // Credenciales de Administradores
    const ADMIN_CREDENTIALS = {
      "admin1@lab.edu": { name: "Admin General" },
      "admin2@lab.edu": { name: "Admin Auxiliar" }
    };

    // --- CORRECCIN: Nombres de grupo simplificados ---
    const GRUPO_LIDERES = {
      "lider1@uni.edu": { name: "Grupo A", color: "red" },
      "lider2@uni.edu": { name: "Grupo B", color: "yellow" },
      "lider3@uni.edu": { name: "Grupo C", color: "green" },
      "lider4@uni.edu": { name: "Grupo D", color: "blue" },
      "lider5@uni.edu": { name: "Grupo E", color: "indigo" },
      "lider6@uni.edu": { name: "Grupo F", color: "purple" },
      "lider7@uni.edu": { name: "Grupo G", color: "pink" }
    };
    
    // Mapa de Colores Tailwind
    const COLOR_MAP = {
      // Usados por el Admin
      red:  { bg: 'bg-red-500', border: 'border-red-700', text: 'text-white' },
      yellow: { bg: 'bg-yellow-500', border: 'border-yellow-700', text: 'text-gray-900' },
      green: { bg: 'bg-green-500', border: 'border-green-700', text: 'text-white' },
      blue:  { bg: 'bg-blue-500', border: 'border-blue-700', text: 'text-white' },
      indigo: { bg: 'bg-indigo-500', border: 'border-indigo-700', text: 'text-white' },
      purple: { bg: 'bg-purple-500', border: 'border-purple-700', text: 'text-white' },
      pink:  { bg: 'bg-pink-500', border: 'border-pink-700', text: 'text-white' }
    };

    // --- RUTAS DE BASE DE DATOS (CONSTANTES) ---
    const RESERVATIONS_COLLECTION = "reservations";
    
    // ==================================================================
    // --- INICIO DE LA APLICACIN (ESPERAR A QUE EL HTML EST LISTO) ---
    // ==================================================================
    
    window.addEventListener('DOMContentLoaded', () => {
    
      // --- INICIALIZACIN DE FIREBASE ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- ESTADO GLOBAL DE LA APLICACIN ---
      let userId = null;
      let userRole = null; // 'admin' o 'student'
      let currentGroupInfo = {};
      let currentWeekOffset = 0; // 0 = Semana Actual, -1 = Semana Pasada, 1 = Semana Siguiente
      let selectedSlots = []; // Para selecci贸n m煤ltiple (Estudiante y Admin)
      let reservationsListener = null; // Para detener el listener al cambiar de semana
      
      // --- Referencias al DOM (AHORA SEGURAS) ---
      const views = {
        login: document.getElementById('login-view'),
        student: document.getElementById('student-dashboard'),
        admin: document.getElementById('admin-dashboard'),
        loading: document.getElementById('loading-view')
      };
      const messageBox = document.getElementById('message-box');

      // --- FUNCIONES DE UTILIDAD (Mensajes, Vistas, Fechas) ---

      function showView(viewName) {
        // Ocultar todas las vistas
        Object.values(views).forEach(el => {
          if (el) { // <-- Verificaci贸n de seguridad
            el.classList.add('hidden');
          }
        });
        
        // Mostrar la vista solicitada
        if (views[viewName]) {
          views[viewName].classList.remove('hidden', 'fade-in');
          // Forzar reflow para reiniciar la animaci贸n
          void views[viewName].offsetWidth;
          views[viewName].classList.add('fade-in');
        } else {
          console.error(`Error: Vista "${viewName}" no encontrada.`);
        }
      }

      function showMessage(type, text) {
        if (!messageBox) return; // <-- Verificaci贸n de seguridad
        messageBox.innerHTML = text;
        messageBox.className = 'p-4 rounded-md text-sm font-medium mb-4';
        if (type === 'error') {
          messageBox.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
          messageBox.classList.add('bg-green-100', 'text-green-700');
        }
        messageBox.classList.remove('hidden');
      }

      function hideMessage() {
        if (messageBox) { // <-- Verificaci贸n de seguridad
          messageBox.classList.add('hidden');
        }
      }

      function getWeekDays(offset = 0) {
        const now = new Date();
        now.setDate(now.getDate() + (offset * 7)); // Moverse N semanas
        const today = now.getDay(); // 0 = Domingo, 1 = Lunes, ..., 6 = S谩bado
        const dayOffset = (today === 0) ? -6 : 1 - today; // Si es Domingo (-6), si no (1 - N)
        
        const monday = new Date(now.setDate(now.getDate() + dayOffset));
        const week = [];
        for (let i = 0; i < 5; i++) { // Solo Lunes (0) a Viernes (4)
          const day = new Date(monday);
          day.setDate(day.getDate() + i);
          week.push(day);
        }
        return week;
      }

      function formatDateYYYYMMDD(date) {
        return date.toISOString().split('T')[0];
      }

      // --- LGICA DE AUTENTICACIN Y SESIN ---

      onAuthStateChanged(auth, (user) => {
        if (user) {
          // Usuario est谩 logueado
          userId = user.uid;
          userRole = ADMIN_CREDENTIALS[user.email] ? 'admin' : 'student';
          
          if (userRole === 'student') {
            // Asignar grupo basado en el email
            currentGroupInfo = GRUPO_LIDERES[user.email] || { name: "Grupo Desconocido", color: "gray" };
            // Asignar ID de usuario 煤nico de Firebase
            currentGroupInfo.userId = userId;
          } else {
            currentGroupInfo = { name: ADMIN_CREDENTIALS[user.email].name, userId: userId };
          }

          initializeDatabaseListener(); // Iniciar la carga de datos
          
        } else {
          // Usuario no est谩 logueado
          userId = null;
          userRole = null;
          currentGroupInfo = {};
          selectedSlots = [];
          showView('login'); // Mostrar vista de login
        }
      });
      
      // Asignar al objeto window para que el HTML (onclick) lo vea
      window.handleLogin = async (event) => {
        event.preventDefault();
        hideMessage();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        // Determinar rol basado en las credenciales
        const isAdmin = !!ADMIN_CREDENTIALS[email];
        const isStudent = !!GRUPO_LIDERES[email];

        if (!isAdmin && !isStudent) {
          showMessage('error', 'Credenciales no reconocidas. Verifique el correo electr贸nico.');
          return;
        }

        try {
          // 1. Limpiar cualquier sesi贸n an贸nima o anterior
          if (auth.currentUser) {
            await signOut(auth);
          }
          
          // 2. Iniciar sesi贸n con Email y Contrase帽a
          await signInWithEmailAndPassword(auth, email, password);
          
          // 3. onAuthStateChanged se encargar谩 del resto (asignar roles y mostrar vistas)

        } catch (error) {
          console.error("Error de autenticaci贸n:", error.code);
          let msg = 'Error al iniciar sesi贸n. Verifique sus credenciales.';
          if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            msg = 'Correo o contrase帽a incorrectos.';
          } else if (error.code === 'auth/too-many-requests') {
            msg = 'Demasiados intentos fallidos. Intente m谩s tarde.';
          }
          showMessage('error', msg);
        }
      };

      window.handleLogout = async () => {
        await signOut(auth);
        // onAuthStateChanged se encargar谩 de limpiar el estado y mostrar el login
      };

      // --- LGICA PRINCIPAL (CARGA DE DATOS) ---

      function initializeDatabaseListener() {
        if (!auth.currentUser) {
          showView('login');
          return;
        }
        
        if (userRole === 'admin') {
          const adminNameEl = document.getElementById('admin-header-name');
          if(adminNameEl) adminNameEl.innerText = currentGroupInfo.name;
          
          showView('admin');
          setupAdminView(); // Configurar la vista de admin
        } else {
          const studentNameEl = document.getElementById('student-header-name');
          if(studentNameEl) studentNameEl.innerText = currentGroupInfo.name;
          
          showView('student');
          setupStudentView(); // Configurar la vista de estudiante
        }
      }
      
      function setupWeekNavigation(prevBtnId, nextBtnId, titleId, calendarRenderer) {
        const prevWeekBtn = document.getElementById(prevBtnId);
        const nextWeekBtn = document.getElementById(nextBtnId);
        const weekTitle = document.getElementById(titleId);

        if (!prevWeekBtn || !nextWeekBtn || !weekTitle) {
          console.error("Error: Elementos de navegaci贸n de semana no encontrados.");
          return;
        }

        const render = () => {
          const weekDays = getWeekDays(currentWeekOffset);
          const start = weekDays[0].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
          const end = weekDays[4].toLocaleDateString('es-ES', { month: 'short', day: 'numeric' });
          weekTitle.innerText = `${start} - ${end}`;
          
          calendarRenderer(weekDays);
        };

        prevWeekBtn.onclick = () => {
          currentWeekOffset--;
          selectedSlots = []; // Limpiar selecci贸n al cambiar de semana
          render();
        };
        
        nextWeekBtn.onclick = () => {
          currentWeekOffset++;
          selectedSlots = []; // Limpiar selecci贸n al cambiar de semana
          render();
        };

        render(); // Carga inicial
      }
      
      // --- LGICA DEL PANEL DE ESTUDIANTE (MODIFICADO) ---

      function setupStudentView() {
        setupWeekNavigation('student-prev-week', 'student-next-week', 'student-week-title', renderStudentCalendar);
        const submitBtn = document.getElementById('submit-request-btn');
        if(submitBtn) submitBtn.onclick = handleSubmitRequest;
      }

      function renderStudentCalendar(weekDays) {
        const tableBody = document.getElementById('student-calendar-body');
        const tableHead = document.getElementById('student-calendar-head');
        
        if(!tableBody || !tableHead) return;
        
        tableHead.innerHTML = ''; // Limpiar cabecera
        tableBody.innerHTML = ''; // Limpiar cuerpo

        if (reservationsListener) reservationsListener(); 

        // Crear Encabezados (Lunes 17/11, Martes 18/11...)
        const headRow = document.createElement('tr');
        headRow.appendChild(createHeaderCell("Hora"));
        weekDays.forEach(day => {
          headRow.appendChild(createHeaderCell(
            `${day.toLocaleDateString('es-ES', { weekday: 'short' })} ${day.getDate()}/${day.getMonth() + 1}`
          ));
        });
        tableHead.appendChild(headRow);

        const hours = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
        const slotMap = new Map();

        hours.forEach(hour => {
          const row = document.createElement('tr');
          // Crear Etiqueta de Hora (07:00 - 08:00)
          row.appendChild(createTimeLabelCell(`${String(hour).padStart(2, '0')}:00 - ${String(hour + 1).padStart(2, '0')}:00`));
          
          // Crear 5 celdas (L-V) para esta hora
          weekDays.forEach(day => {
            const slotId = `${formatDateYYYYMMDD(day)}_${hour}`;
            const cell = document.createElement('td');
            const slotContainer = createSlotContainer();
            const slot = createSlotElement(slotId, 'student');
            
            slotContainer.appendChild(slot);
            cell.appendChild(slotContainer);
            row.appendChild(cell);
            
            slotMap.set(slotId, slot);
          });
          tableBody.appendChild(row);
        });

        const startOfWeek = formatDateYYYYMMDD(weekDays[0]);
        const endOfWeek = formatDateYYYYMMDD(weekDays[4]);

        // Query para obtener todas las reservas de la semana (independiente del estado)
        const q = query(
          collection(db, RESERVATIONS_COLLECTION),
          where("date", ">=", startOfWeek),
          where("date", "<=", endOfWeek)
        );

        reservationsListener = onSnapshot(q, (snapshot) => {
          resetCalendarSlots(slotMap, 'student');
          
          // 1. Agrupar todas las reservas por slot (Date_Hour)
          const aggregatedSlots = new Map();
          
          snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id; 
            const slotId = `${data.date}_${data.hour}`;
            
            if (!aggregatedSlots.has(slotId)) {
              aggregatedSlots.set(slotId, []);
            }
            aggregatedSlots.get(slotId).push(data);
          });
          
          // 2. Iterar sobre los slots y aplicar la l贸gica de visualizaci贸n de Estudiante
          aggregatedSlots.forEach((reservations, slotId) => {
            const slotElement = slotMap.get(slotId);
            if (!slotElement || slotElement.dataset.status === 'past') return;
            
            // Encontrar la reserva dominante
            let dominantReservation = null;
            
            // Orden de prioridad: Bloqueado > M铆o Aprobado > Otros Aprobados > M铆o Pendiente > Otros Pendientes
            const blocked = reservations.find(r => r.status === 'blocked');
            const myApproved = reservations.find(r => r.status === 'approved' && r.userId === userId);
            const otherApproved = reservations.find(r => r.status === 'approved' && r.userId !== userId);
            const myPending = reservations.find(r => r.status === 'pending' && r.userId === userId);
            const otherPending = reservations.find(r => r.status === 'pending' && r.userId !== userId);
            
            if (blocked) {
              dominantReservation = blocked;
            } else if (myApproved) {
              dominantReservation = myApproved;
            } else if (otherApproved) {
              dominantReservation = otherApproved;
            } else if (myPending) {
              dominantReservation = myPending;
            } else if (otherPending) {
              dominantReservation = otherPending;
            }
            
            // Si hay una reserva dominante, actualizar el slot (y limpiar si es 'selected')
            if (dominantReservation) {
              updateSlotAppearance(slotElement, dominantReservation, 'student');
            }
          });
          
          // Asegurar que los slots seleccionados se mantengan (si no hay conflicto)
          selectedSlots.forEach(slotId => {
            const slot = slotMap.get(slotId);
            if (slot && slot.dataset.status === 'free') {
              slot.classList.add('slot-selected');
              slot.dataset.status = 'selected';
              slot.innerHTML = '<span class="slot-text">Seleccionado</span>';
            }
          });
          
          updateSubmitBox();
          
        }, (error) => {
          console.error("Error al cargar reservaciones: ", error);
          showMessage('error', 'Error al conectar con la base de datos de turnos.');
        });
      }
      
      function handleStudentSlotClick(slot) {
        const slotId = slot.id;
        const status = slot.dataset.status;

        if (status === 'free') {
          // --- CORRECCIN: Agregar texto 'Seleccionado' al bloque azul ---
          slot.innerHTML = '<span class="slot-text">Seleccionado</span>';
          slot.classList.add('slot-selected');
          slot.dataset.status = 'selected';
          selectedSlots.push(slotId);
        } else if (status === 'selected') {
          // --- CORRECCIN: Remover texto al deseleccionar ---
          slot.innerHTML = ''; 
          slot.classList.remove('slot-selected');
          slot.dataset.status = 'free';
          selectedSlots = selectedSlots.filter(s => s !== slotId);
        } else if (slot.dataset.owner === 'self' && (status === 'pending' || status === 'approved')) {
          // Permitir al usuario cancelar su propia solicitud PENDIENTE o APROBADA
          const statusText = status === 'pending' ? 'solicitud PENDIENTE' : 'reserva APROBADA';
          if (confirm(`驴Est谩s seguro de que quieres ANULAR esta ${statusText}?`)) {
            cancelReservation(slot.dataset.docId);
          }
        }
        
        updateSubmitBox();
      }
      
      function updateSubmitBox() {
        const box = document.getElementById('student-request-box');
        const btn = document.getElementById('submit-request-btn');
        const text = document.getElementById('student-request-count');
        
        if (!box || !btn || !text) return; 

        if (selectedSlots.length > 0) {
          text.innerText = `${selectedSlots.length} hora(s) seleccionada(s).`;
          btn.disabled = false;
          box.classList.remove('hidden', 'fade-in');
          void box.offsetWidth;
          box.classList.add('fade-in');
        } else {
          box.classList.add('hidden');
          btn.disabled = true;
        }
      }
      
      async function handleSubmitRequest() {
        if (selectedSlots.length === 0) return;

        const batch = writeBatch(db);
        let hasConflicts = false;
        let conflictSlot = null;

        for (const slotId of selectedSlots) {
          const slotElement = document.getElementById(slotId);
          if (slotElement && slotElement.dataset.status !== 'free' && slotElement.dataset.status !== 'selected') {
            hasConflicts = true;
            conflictSlot = slotId;
            break;
          }
        }

        if (hasConflicts) {
          showMessage('error', `El turno ${conflictSlot} ya no est谩 disponible. Por favor, refresca tu selecci贸n.`);
          selectedSlots = [];
          document.querySelectorAll('.slot-selected').forEach(s => {
            s.classList.remove('slot-selected');
            s.dataset.status = 'free';
          });
          updateSubmitBox();
          return;
        }
        
        selectedSlots.forEach(slotId => {
          const [date, hourStr] = slotId.split('_');
          const hour = parseInt(hourStr);
          const newDocRef = doc(collection(db, RESERVATIONS_COLLECTION));
          
          batch.set(newDocRef, {
            date: date,
            hour: hour,
            status: 'pending',
            userId: userId,
            groupName: currentGroupInfo.name,
            groupColor: currentGroupInfo.color,
            createdAt: serverTimestamp()
          });
        });

        try {
          await batch.commit();
          showMessage('success', `${selectedSlots.length} solicitud(es) enviada(s) con 茅xito.`);
          selectedSlots = [];
          updateSubmitBox();
        } catch (error) {
          console.error("Error al enviar solicitudes: ", error);
          showMessage('error', 'Error al guardar las solicitudes.');
        }
      }
      
      async function cancelReservation(docId) {
        if (!docId) {
          console.error("Error: docId es nulo al cancelar.");
          return;
        }
        try {
          await deleteDoc(doc(db, RESERVATIONS_COLLECTION, docId));
          showMessage('success', 'Reserva cancelada.');
        } catch (error) {
          console.error("Error al cancelar: ", error);
          showMessage('error', 'No se pudo cancelar la reserva.');
        }
      }
      
      // --- LGICA DEL PANEL DE ADMINISTRADOR (MODIFICADO) ---

      function setupAdminView() {
        setupWeekNavigation('admin-prev-week', 'admin-next-week', 'admin-week-title', renderAdminCalendar);
        
        const blockBtn = document.getElementById('admin-block-btn');
        const unblockBtn = document.getElementById('admin-unblock-btn');
        
        if (blockBtn) blockBtn.onclick = () => handleAdminBlockAction('blocked');
        if (unblockBtn) unblockBtn.onclick = () => handleAdminBlockAction('free');

        listenForPendingRequests();
      }
      
      function renderAdminCalendar(weekDays) {
        const tableBody = document.getElementById('admin-calendar-body');
        const tableHead = document.getElementById('admin-calendar-head');
        
        if(!tableBody || !tableHead) return;
        
        tableHead.innerHTML = '';
        tableBody.innerHTML = '';
        if (reservationsListener) reservationsListener();

        const headRow = document.createElement('tr');
        headRow.appendChild(createHeaderCell("Hora"));
        weekDays.forEach(day => {
          headRow.appendChild(createHeaderCell(
            `${day.toLocaleDateString('es-ES', { weekday: 'short' })} ${day.getDate()}/${day.getMonth() + 1}`
          ));
        });
        tableHead.appendChild(headRow);

        const hours = [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19];
        const slotMap = new Map();

        hours.forEach(hour => {
          const row = document.createElement('tr');
          row.appendChild(createTimeLabelCell(`${String(hour).padStart(2, '0')}:00 - ${String(hour + 1).padStart(2, '0')}:00`));
          weekDays.forEach(day => {
            const slotId = `${formatDateYYYYMMDD(day)}_${hour}`;
            const cell = document.createElement('td');
            const slotContainer = createSlotContainer();
            const slot = createSlotElement(slotId, 'admin');
            
            slotContainer.appendChild(slot);
            cell.appendChild(slotContainer);
            row.appendChild(cell);
            
            slotMap.set(slotId, slot);
          });
          tableBody.appendChild(row);
        });

        const startOfWeek = formatDateYYYYMMDD(weekDays[0]);
        const endOfWeek = formatDateYYYYMMDD(weekDays[4]);

        const q = query(
          collection(db, RESERVATIONS_COLLECTION),
          where("date", ">=", startOfWeek),
          where("date", "<=", endOfWeek)
        );

        reservationsListener = onSnapshot(q, (snapshot) => {
          resetCalendarSlots(slotMap, 'admin');
          
          const aggregatedSlots = new Map();
          snapshot.forEach(doc => {
            const data = doc.data();
            data.id = doc.id;
            const slotId = `${data.date}_${data.hour}`;
            
            if (!aggregatedSlots.has(slotId)) {
              aggregatedSlots.set(slotId, []);
            }
            aggregatedSlots.get(slotId).push(data);
          });
    
          aggregatedSlots.forEach((reservations, slotId) => {
            const slotElement = slotMap.get(slotId);
            if (!slotElement || slotElement.dataset.status === 'past') return;
            
            // === L贸gica de Agregaci贸n para Admin ===
            
            const approvedReservations = reservations.filter(r => r.status === 'approved');
            const approvedCount = approvedReservations.length;
            const pendingCount = reservations.filter(r => r.status === 'pending').length;
            const blocked = reservations.find(r => r.status === 'blocked');
            
            // Determinar el estado dominante para la visualizaci贸n del Admin
            let displayData = null;
            
            if (blocked) {
              // Prioridad m谩xima: Bloqueado
              displayData = blocked;
            } else if (approvedCount > 0) {
              // Segunda prioridad: Aprobado (mostrar el primer aprobado encontrado con contador)
              displayData = approvedReservations[0]; 
              displayData.groupName = approvedCount === 1 
                ? displayData.groupName
                : `${approvedReservations[0].groupName} (+${approvedCount - 1})`;
              displayData.isAggregated = true;
              
              if (pendingCount > 0) {
                displayData.groupName += ` P: ${pendingCount}`;
              }
            } else if (pendingCount > 0) {
              // Tercera prioridad: Pendiente (mostrar el primer pendiente encontrado con contador)
              displayData = reservations.find(r => r.status === 'pending');
              displayData.groupName = `Pendientes: ${pendingCount}`;
              displayData.isAggregated = true; 
              displayData.groupColor = 'yellow';
            }
    
            if (displayData) {
              updateSlotAppearance(slotElement, displayData, 'admin');
            }
          });
          
          selectedSlots = [];
          updateAdminActionBox();
        });
      }
      
      function handleAdminSlotClick(slot) {
        const slotId = slot.id;
        const status = slot.dataset.status;

        // Permitir selecci贸n de slots libres o bloqueados por el admin
        if (status === 'free' || status === 'blocked') {
          if (selectedSlots.includes(slotId)) {
            selectedSlots = selectedSlots.filter(s => s !== slotId);
            slot.classList.remove('slot-selected');
            slot.innerHTML = (status === 'free') ? '<span class="slot-text">Disponible</span>' : '<span class="slot-text">Bloqueado</span>';
          } else {
            selectedSlots.push(slotId);
            slot.classList.add('slot-selected');
            slot.innerHTML = '<span class="slot-text">Seleccionado</span>';
          }
        } else if (status === 'approved') {
          // Permitir al Admin cancelar (derrogar) turnos aprobados
          if (confirm(`驴Seguro que quieres DERROGAR el turno aprobado de ${slot.dataset.groupName}?`)) {
            cancelReservation(slot.dataset.docId);
          }
        }
        
        updateAdminActionBox();
      }
      
      function updateAdminActionBox() {
        const box = document.getElementById('admin-action-box');
        const countEl = document.getElementById('admin-selection-count');
        
        if (!box || !countEl) return; 
        
        if (selectedSlots.length > 0) {
          box.classList.remove('hidden');
          countEl.innerText = `${selectedSlots.length} hora(s) seleccionada(s).`;
        } else {
          box.classList.add('hidden');
        }
      }
      
      async function handleAdminBlockAction(action) {
        if (selectedSlots.length === 0) return;
        
        const batch = writeBatch(db);
        
        for (const slotId of selectedSlots) {
          const [date, hourStr] = slotId.split('_');
          const hour = parseInt(hourStr);
          const docId = `ADMIN_BLOCK_${date}_${hour}`;
          const docRef = doc(db, RESERVATIONS_COLLECTION, docId);

          if (action === 'blocked') {
            batch.set(docRef, {
              date: date,
              hour: hour,
              status: 'blocked',
              groupName: 'Admin Block',
              userId: userId,
              createdAt: serverTimestamp()
            });
          } else {
            batch.delete(docRef);
          }
        }
        
        try {
          await batch.commit();
          showMessage('success', `Operaci贸n completada en ${selectedSlots.length} slots.`);
          selectedSlots = [];
          updateAdminActionBox();
        } catch (error) {
          console.error("Error al actualizar bloques de admin: ", error);
          showMessage('error', 'Error al guardar los cambios.');
        }
      }

      // --- L贸gica Com煤n de Renderizado de Calendario (TABLA) ---

      function createHeaderCell(text) {
        const th = document.createElement('th');
        th.innerText = text;
        return th;
      }
      
      function createTimeLabelCell(text) {
        const td = document.createElement('td');
        td.className = 'time-label';
        td.innerText = text;
        return td;
      }
      
      function createSlotContainer() {
        const div = document.createElement('div');
        div.className = 'slot-container';
        return div;
      }

      function createSlotElement(slotId, role) {
        const slot = document.createElement('button'); // Usar bot贸n para mejor accesibilidad
        slot.id = slotId;
        slot.className = 'slot';
        slot.type = 'button'; // Prevenir env铆o de formulario
        
        if (role === 'student') {
          slot.onclick = () => handleStudentSlotClick(slot);
        } else if (role === 'admin') {
          slot.onclick = () => handleAdminSlotClick(slot);
        }
        
        return slot;
      }

      function resetCalendarSlots(slotMap, role) {
        const now = new Date();
        now.setHours(now.getHours(), 0, 0, 0);

        slotMap.forEach((slot, slotId) => {
          const [dateStr, hourStr] = slotId.split('_');
          const slotDate = new Date(`${dateStr}T${String(hourStr).padStart(2, '0')}:00:00`);
          
          slot.className = 'slot'; // Limpiar colores anteriores
          slot.innerHTML = ''; // Limpiar texto
          slot.disabled = false; // Habilitar slot
          
          if (slotDate < now) {
            // Slot en el pasado
            slot.dataset.status = 'past';
            slot.classList.add('slot-past');
            // --- CORRECCIN DE TEXTO ---
            slot.innerHTML = '<span class="slot-text">No Disponible</span>';
            slot.disabled = true;
          } else {
            // Slot libre
            slot.dataset.status = 'free';
            slot.classList.add('slot-free');
            if (role === 'admin') {
              slot.innerHTML = '<span class="slot-text">Disponible</span>';
            }
          }
          
          slot.dataset.docId = '';
          slot.dataset.owner = '';
          slot.dataset.groupName = '';
        });
      }
      
      function updateSlotAppearance(slot, data, role) {
        slot.dataset.docId = data.id || ''; 
        slot.dataset.status = data.status;
        slot.dataset.groupName = data.groupName || '';
        
        let colorClasses = '';
        let content = data.groupName;
        slot.disabled = false; // Por defecto
        
        const isOwner = (data.userId === userId);
        slot.dataset.owner = isOwner ? 'self' : 'other';

        switch (data.status) {
          case 'pending':
            colorClasses = 'slot-pending';
            if (role === 'admin') {
              const color = COLOR_MAP[data.groupColor] || { bg: 'bg-gray-400', border: 'border-gray-500', text: 'text-black' };
              slot.classList.add(color.bg, color.border, color.text, 'slot-admin-view-pending');
              content = `Pendiente (${data.groupName})`;
            } else {
              // --- CORRECCIN DE TEXTO: Simplificado ---
              content = isOwner ? 'Mi Solicitud' : 'Pendiente';
            }
            break;
            
          case 'approved':
            if (role === 'admin') {
              const color = COLOR_MAP[data.groupColor] || { bg: 'bg-gray-700', border: 'border-gray-900', text: 'text-white' };
              slot.classList.add(color.bg, color.border, color.text, 'slot-admin-view-approved');
              content = data.groupName;
            } else {
              // --- LGICA DE COLORES VERDE/ROJO (Estricta) ---
              if (isOwner) {
                colorClasses = 'slot-approved-self'; // Verde
                content = "Agendado"; // <-- REQUERIDO
              } else {
                colorClasses = 'slot-approved-other'; // Rojo
                content = "Reservado"; // <-- REQUIDO (Sin nombre de grupo)
              }
            }
            break;
            
          case 'blocked':
            colorClasses = 'slot-blocked'; // Gris
            content = 'No Disponible';
            // --- 隆CORRECCIN DE BUG! ---
            // El admin S debe poder hacer clic en slots bloqueados.
            if (role === 'admin') {
              slot.disabled = false;
              slot.classList.add('admin-clickable'); // A帽adir estilo hover
              content = 'Bloqueado';
            } else {
              slot.disabled = true;
            }
            break;
        }
        
        if (colorClasses) slot.classList.add(colorClasses);
        slot.innerHTML = `<span class="slot-text">${content}</span>`;
      }

      
      // --- L贸gica del Panel de Aprobaci贸n (Admin) ---

      function listenForPendingRequests() {
        // *** CORRECCIN CRTICA ***
        // Quitar 'orderBy' para evitar el error de 铆ndice de Firestore.
        // La ordenaci贸n se har谩 localmente.
        const q = query(
          collection(db, RESERVATIONS_COLLECTION),
          where("status", "==", "pending")
        );

        onSnapshot(q, (snapshot) => {
          const listContainer = document.getElementById('admin-requests-list');
          if (!listContainer) return; 
          
          listContainer.innerHTML = '';
          
          if (snapshot.empty) {
            listContainer.innerHTML = '<div class="text-center text-gray-400 p-4">No hay solicitudes pendientes.</div>';
            return;
          }
          
          // Ordenar localmente
          const requests = [];
          snapshot.forEach(doc => {
            requests.push({ id: doc.id, data: doc.data() });
          });
          
          // Ordenar por fecha de creaci贸n (ascendente)
          requests.sort((a, b) => {
            const aTime = a.data.createdAt?.toMillis() || 0;
            const bTime = b.data.createdAt?.toMillis() || 0;
            return aTime - bTime; 
          });

          requests.forEach(req => {
            listContainer.appendChild(createRequestRow(req.id, req.data));
          });
        }, (error) => {
          // Este es el error que viste en la consola
          console.error("Error al cargar solicitudes pendientes: ", error);
          showMessage('error', 'Error al cargar la lista de solicitudes. Verifique los permisos de Firestore.');
        });
      }
      
      function createRequestRow(docId, data) {
        const div = document.createElement('div');
        const color = data.groupColor || 'gray';
        const colorClass = COLOR_MAP[color]?.bg || 'bg-gray-200'; // Usar color s贸lido
        const textColor = COLOR_MAP[color]?.text || 'text-gray-900';
        
        div.className = `p-3 rounded-lg shadow-sm mb-3 flex justify-between items-center ${colorClass} ${textColor}`;
        
        // Formatear la fecha para que sea legible
        const requestDate = new Date(`${data.date}T00:00:00`).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
        
        div.innerHTML = `
          <div class="flex-1 overflow-hidden">
            <div class="font-bold text-sm truncate">${data.groupName}</div>
            <div class="text-xs opacity-80">
              ${requestDate} | ${data.hour}:00
            </div>
            </div>
          <div class="flex gap-2 ml-2">
            <button onclick="window.updateReservationStatus('${docId}', 'approved')" 
                class="bg-green-500 text-white w-8 h-8 rounded-full leading-none hover:bg-green-600 shadow-md flex items-center justify-center"
                title="Aprobar">
              <i class="fas fa-check"></i>
            </button>
            <button onclick="window.updateReservationStatus('${docId}', 'rejected')" 
                class="bg-red-500 text-white w-8 h-8 rounded-full leading-none hover:bg-red-600 shadow-md flex items-center justify-center"
                title="Rechazar">
              <i class="fas fa-times"></i>
            </button>
          </div>
        `;
        return div;
      }
      
      // === FUNCIN CRTICA CON LGICA DE LMITE DE 4 (MODIFICADA) ===
      window.updateReservationStatus = async (docId, newStatus) => {
        const docRef = doc(db, RESERVATIONS_COLLECTION, docId);
        
        if (newStatus === 'rejected') {
          // Rechazar es simplemente borrar el documento
          try {
            await deleteDoc(docRef);
            showMessage('success', 'Solicitud rechazada (borrada).');
          } catch (e) {
            console.error("Error al rechazar: ", e);
            showMessage('error', 'Error al rechazar la solicitud.');
          }
        } else if (newStatus === 'approved') {
          // Aprobar requiere verificar conflictos primero
          try {
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists() || docSnap.data().status !== 'pending') {
              showMessage('error', 'Esta solicitud ya no existe o no est谩 pendiente.');
              return;
            }
            const data = docSnap.data();
            
            // 1. Contar cu谩ntos slots est谩n APROBADOS o BLOQUEADOS para este turno
            const conflictQuery = query(
              collection(db, RESERVATIONS_COLLECTION),
              where("date", "==", data.date),
              where("hour", "==", data.hour),
              where("status", "in", ["approved", "blocked"])
            );
            
            const existingReservations = await getDocs(conflictQuery);
            const approvedCount = existingReservations.docs.filter(d => d.data().status === 'approved').length;
            const blockedCount = existingReservations.docs.filter(d => d.data().status === 'blocked').length;
            
            if (blockedCount > 0) {
              // Si hay un bloqueo (manual o autom谩tico) no se puede aprobar
              showMessage('error', `Este slot est谩 bloqueado por el administrador o se alcanz贸 el l铆mite. No se puede aprobar.`);
              await deleteDoc(docRef); // Borrar la solicitud pendiente
            } else if (approvedCount >= 4) { 
              // Si ya hay 4 grupos aprobados, se ha alcanzado el l铆mite.
              showMessage('error', `Ya hay ${approvedCount} turnos aprobados para este slot. Se alcanz贸 el l铆mite de 4.`);
              // Borrar la solicitud pendiente conflictiva
              await deleteDoc(docRef); 
            } else {
              // 2. No hay conflicto ni bloqueo: Aprobar el turno
              await updateDoc(docRef, { status: 'approved' });
              showMessage('success', 'Turno aprobado.');

              // 3. L贸gica de Bloqueo Autom谩tico (Si se llega al l铆mite de 4)
              if (approvedCount + 1 >= 4) { // Si se aprueba y se llega a 4
                const blockDocId = `AUTO_BLOCK_${data.date}_${data.hour}`;
                const blockDocRef = doc(db, RESERVATIONS_COLLECTION, blockDocId);
                
                // Crear un documento de bloqueo que ser谩 visible para todos
                await setDoc(blockDocRef, {
                  date: data.date,
                  hour: data.hour,
                  status: 'blocked',
                  groupName: 'L铆mite Alcanzado', 
                  userId: 'SYSTEM',
                  createdAt: serverTimestamp()
                });
                
                // Borrar *todas* las solicitudes pendientes restantes en el mismo slot
                const otherPendingQuery = query(
                  collection(db, RESERVATIONS_COLLECTION),
                  where("date", "==", data.date),
                  where("hour", "==", data.hour),
                  where("status", "==", "pending")
                );
                
                const pendingToClear = await getDocs(otherPendingQuery);
                const batchClear = writeBatch(db);
                pendingToClear.forEach(doc => {
                  batchClear.delete(doc.ref);
                });
                await batchClear.commit();

                showMessage('success', 'Turno aprobado. 隆L铆mite de 4 alcanzado y slot bloqueado!');
              }
            }
            
          } catch (e) {
            console.error("Error al aprobar: ", e);
            showMessage('error', 'Error al aprobar la solicitud.');
          }
        }
      };

      // --- INICIO DE LA APLICACIN ---
      
      // Clonar y rellenar los encabezados de la aplicaci贸n
      function fillHeaders() {
        const template = document.getElementById('app-header-template');
        if (!template) {
          console.error("Error cr铆tico: No se encontr贸 el template del header.");
          return;
        }
        
        // Llenar header de estudiante
        const studentPlaceholder = document.getElementById('student-header-placeholder');
        if (studentPlaceholder) {
          const studentHeader = template.content.cloneNode(true);
          studentHeader.getElementById('header-subtitle').innerText = 'Panel de Estudiante';
          studentHeader.getElementById('header-name-display').id = 'student-header-name';
          studentPlaceholder.appendChild(studentHeader);
        }

        // Llenar header de admin
        const adminPlaceholder = document.getElementById('admin-header-placeholder');
        if (adminPlaceholder) {
          const adminHeader = template.content.cloneNode(true);
          adminHeader.getElementById('header-subtitle').innerText = 'Panel de Administraci贸n';
          adminHeader.getElementById('header-name-display').id = 'admin-header-name';
          adminPlaceholder.appendChild(adminHeader);
        }
      }
      
      // --- Punto de entrada principal ---
      fillHeaders();
      showView('loading'); // Mostrar carga mientras Firebase se autentica

    }); // <-- Fin del DOMContentLoaded

  </script>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="login-view" class="min-h-screen flex flex-col items-center justify-center p-4">
    
        <header class="w-full max-w-md mb-6 text-center">
      <div class="bg-slate-800 p-4 rounded-t-xl flex items-center justify-center text-white space-x-3">
                <span class="text-4xl"></span>
        <div>
          <h1 class="text-xl font-bold">Universidad Central del Ecuador</h1>
          <p class="text-sm text-slate-300">Gesti贸n de Turnos - Laboratorio de Redes</p>
        </div>
      </div>
    </header>

    <div class="max-w-md w-full bg-white rounded-b-xl rounded-t-lg shadow-xl overflow-hidden fade-in">
      <form onsubmit="window.handleLogin(event)" class="p-8 space-y-6">
        <h2 class="text-2xl font-bold text-center text-slate-700">Acceso al Sistema</h2>
        
                <div id="message-box" class="hidden"></div>
        
        <div class="space-y-4">
          <div>
            <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Correo Institucional</label>
            <input type="email" id="login-email" placeholder="ej: lider1@uni.edu" class="w-full border border-gray-300 p-3 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
          <div>
            <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Contrase帽a</label>
            <input type="password" id="login-password" placeholder="⑩⑩⑩⑩⑩⑩⑩" class="w-full border border-gray-300 p-3 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
          </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold text-base hover:bg-blue-700 shadow-md transition duration-300">Ingresar</button>
      </form>
    </div>
  </div>

    <div id="loading-view" class="hidden min-h-screen flex items-center justify-center">
    <div class="text-center">
      <i class="fas fa-spinner fa-spin text-4xl text-slate-600"></i>
      <p class="mt-3 text-lg font-medium text-slate-700">Cargando...</p>
    </div>
  </div>
  
    <template id="app-header-template">
    <header class="bg-slate-800 text-white shadow-md sticky top-0 z-10">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl"></span>
            <div>
              <h1 class="text-lg font-bold">Gesti贸n de Turnos - Laboratorio de Redes</h1>
              <p class="text-xs text-slate-300" id="header-subtitle"></p>
            </div>
          </div>
                    <div class="flex items-center space-x-3">
            <span class="text-sm font-medium hidden sm:block" id="header-name-display"></span>
            <button onclick="window.handleLogout()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-md text-sm font-medium transition">
              <i class="fas fa-sign-out-alt mr-1 sm:mr-2"></i>
              <span class="hidden sm:inline">Salir</span>
            </button>
          </div>
        </div>
      </div>
    </header>
  </template>
  
    <div id="student-dashboard" class="hidden">
        <header id="student-header-placeholder"></header>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4 p-4 bg-white rounded-lg shadow-xl">
            <button id="student-prev-week" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg shadow transition">
              <i class="fas fa-chevron-left"></i> Semana Ant.
            </button>
            <h2 id="student-week-title" class="text-xl sm:text-2xl font-extrabold text-slate-700 text-center"></h2>
            <button id="student-next-week" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg shadow transition">
              Semana Sig. <i class="fas fa-chevron-right"></i>
            </button>
          </div>

                    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <table class="calendar-table">
              <thead id="student-calendar-head">
                              </thead>
              <tbody id="student-calendar-body">
                              </tbody>
            </table>
          </div>

                    <div id="student-request-box" class="hidden mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-400 rounded-lg shadow-md flex justify-between items-center">
            <p id="student-request-count" class="text-lg font-semibold text-yellow-800">X hora(s) seleccionada(s).</p>
            <button id="submit-request-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow transition" disabled>
              <i class="fas fa-paper-plane mr-2"></i> Enviar Solicitud
            </button>
          </div>
        </div>
        
                <div class="lg:col-span-1">
          <div class="bg-white p-6 rounded-lg shadow-xl sticky top-20">
            <h3 class="text-xl font-extrabold text-slate-800 border-b pb-3 mb-4">Leyenda de Estados</h3>
            <div class="space-y-4">
                            <div class="legend-item">
                <div class="legend-slot slot-free border-gray-300">Disponible</div>
                <span class="text-sm text-gray-700 font-medium">- Disponible</span>
              </div>
              <div class="legend-item">
                <div class="legend-slot slot-selected">Mi Selecci贸n</div>
                <span class="text-sm text-gray-700 font-medium">- Horas que est谩s por solicitar</span>
              </div>
                            <div class="legend-item">
                <div class="legend-slot slot-approved-self">Agendado</div>
                <span class="text-sm text-gray-700 font-medium">- Mi turno confirmado</span>
              </div>
              <div class="legend-item">
                <div class="legend-slot slot-pending">Pendiente</div>
                <span class="text-sm text-gray-700 font-medium">- Solicitudes de otros grupos</span>
              </div>
              <div class="legend-item">
                <div class="legend-slot slot-approved-other">Reservado</div>
                <span class="text-sm text-gray-700 font-medium">- Turno de otro grupo</span>
              </div>
              <div class="legend-item">
                <div class="legend-slot slot-blocked">No Disponible</div>
                <span class="text-sm text-gray-700 font-medium">- Horario bloqueado o pasado</span>
              </div>
            </div>
          </div>
        </div>
        
      </div>
    </main>
  </div>

    <div id="admin-dashboard" class="hidden">
        <header id="admin-header-placeholder"></header>
    
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-4 p-4 bg-white rounded-lg shadow-xl">
            <button id="admin-prev-week" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg shadow transition">
              <i class="fas fa-chevron-left"></i> Semana Ant.
            </button>
            <h2 id="admin-week-title" class="text-xl sm:text-2xl font-extrabold text-slate-700 text-center"></h2>
            <button id="admin-next-week" class="bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded-lg shadow transition">
              Semana Sig. <i class="fas fa-chevron-right"></i>
            </button>
          </div>

                    <div class="bg-white rounded-lg shadow-xl overflow-hidden">
            <table class="calendar-table">
              <thead id="admin-calendar-head">
                              </thead>
              <tbody id="admin-calendar-body">
                              </tbody>
            </table>
          </div>
          
                    <div id="admin-action-box" class="hidden mt-6 p-4 bg-gray-700 text-white rounded-lg shadow-md flex justify-between items-center">
            <p id="admin-selection-count" class="text-lg font-semibold">X hora(s) seleccionada(s).</p>
            <div class="space-x-2">
              <button id="admin-block-btn" class="bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg shadow transition">
                <i class="fas fa-lock mr-2"></i> Bloquear
              </button>
              <button id="admin-unblock-btn" class="bg-green-600 hover:bg-green-700 font-bold py-2 px-4 rounded-lg shadow transition">
                <i class="fas fa-lock-open mr-2"></i> Desbloquear
              </button>
            </div>
          </div>
        </div>
        
                <div class="lg:col-span-1">
          <div class="bg-white p-6 rounded-lg shadow-xl sticky top-20">
            <h3 class="text-xl font-extrabold text-slate-800 border-b pb-3 mb-4 shadow-sm px-2">
              <i class="fas fa-tasks mr-2 text-blue-600"></i>
              Solicitudes Pendientes
            </h3>
            <div id="admin-requests-list" class="space-y-3 max-h-[70vh] overflow-y-auto">
                          </div>
          </div>
        </div>

      </div>
    </main>
  </div>

</body>
</html>